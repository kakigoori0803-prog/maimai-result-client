(()=>{const API="https://maimai-result.onrender.com/ingest";const TOKEN="677212069901c46a68a76e31ad8ba32a";const RESULT_URL="https://kakigoori0803-prog.github.io/maimai-result-client/";const ID="mrc-overlay";const Q=(s,r=document)=>r.querySelector(s);const QA=(s,r=document)=>Array.from(r.querySelectorAll(s));const sleep=t=>new Promise(r=>setTimeout(r,t));try{if(Q("#"+ID))Q("#"+ID).remove();const css="#mrc-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2147483647;display:flex;align-items:center;justify-content:center;-webkit-user-select:none;user-select:none}#mrc-box{width:min(520px,92vw);background:#0f1720;color:#e6edf3;border-radius:16px;border:1px solid #263141;box-shadow:0 20px 60px rgba(0,0,0,.35);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial}#mrc-hd{padding:14px 16px;border-bottom:1px solid #263141;font-weight:800}#mrc-bd{padding:14px 16px;line-height:1.6}#mrc-ft{padding:12px 16px;display:flex;gap:10px;justify-content:flex-end}.mrc-btn{appearance:none;border:0;border-radius:10px;padding:12px 14px;font-weight:800}.mrc-ghost{background:#1b2430;color:#e6edf3}.mrc-primary{background:#1bd6c1;color:#022e2a}.mrc-btn:disabled{opacity:.6}#mrc-bar{height:8px;background:#17202b;border-radius:999px;overflow:hidden;margin-top:10px;display:none}#mrc-bar>i{display:block;height:100%;width:0;background:#1bd6c1;transition:width .2s}.mrc-muted{color:#99a7bd;font-size:13px}";
const st=document.createElement("style");st.textContent=css;document.head.appendChild(st);
const ov=document.createElement("div");ov.id=ID;ov.innerHTML='<div id="mrc-box" role="dialog" aria-modal="true"><div id="mrc-hd">maimai Result Client</div><div id="mrc-bd"><div id="mrc-msg">履歴データを取得・送信します。</div><div id="mrc-bar"><i id="mrc-p"></i></div><div class="mrc-muted" id="mrc-sub"></div></div><div id="mrc-ft"><button id="mrc-cancel" class="mrc-btn mrc-ghost">戻る</button><button id="mrc-go" class="mrc-btn mrc-primary">開始</button></div></div>';document.body.appendChild(ov);
const $=id=>document.getElementById(id);const bind=(el,fn)=>{const h=e=>{e&&e.preventDefault();e&&e.stopPropagation();fn()};el.addEventListener("click",h,{passive:false});el.addEventListener("touchend",h,{passive:false});};const block=e=>{e.preventDefault();e.stopPropagation()};ov.addEventListener("touchmove",block,{passive:false});ov.addEventListener("wheel",block,{passive:false});
const close=()=>ov.remove();
bind($("#mrc-cancel"),close);
const onRecord=/\/maimai-mobile\/record\//.test(location.pathname);
if(!onRecord){$("#mrc-msg").textContent="履歴一覧（/maimai-mobile/record/）で実行してください。";$("#mrc-sub").textContent="ホームや詳細ページでは取得できません。";$("#mrc-go").textContent="履歴へ移動";$("#mrc-bar").style.display="none";bind($("#mrc-go"),()=>{location.assign("/maimai-mobile/record/")});return}
const rawLinks=QA('a[href*="playlogDetail"]');const urls=[...new Set(rawLinks.map(a=>{try{return new URL(a.getAttribute("href"),location.href).href}catch(e){return null}}).filter(Boolean))];
const total=urls.length;const msg=$("#mrc-msg"),sub=$("#mrc-sub"),bar=$("#mrc-bar"),p=$("#mrc-p"),go=$("#mrc-go"),back=$("#mrc-cancel");
if(!total){msg.textContent="履歴の詳細リンクが見つかりませんでした。";sub.textContent="ページを再読み込みして再実行してください。";go.style.display="none";return}
msg.textContent=`履歴データ（${total}件）を取得・送信します。`;sub.textContent="準備できたら「開始」を押してください。";
bind(go,async()=>{go.disabled=true;back.disabled=true;bar.style.display="block";go.textContent="取得中";sub.textContent=`進捗: 0/${total}`;
let ok=0,ng=0;const post=async (html,url)=>{await fetch(API,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+TOKEN},body:JSON.stringify({html,url})})};
for(let i=0;i<urls.length;i++){const url=urls[i];try{const html=await fetch(url,{credentials:"include"}).then(r=>r.text());await post(html,url);ok++}catch(e){ng++}p.style.width=Math.round(((i+1)/total)*100)+"%";sub.textContent=`進捗: ${i+1}/${total}`;await sleep(20)}
msg.textContent=`完了: ${ok}/${total}　失敗: ${ng} 件`;go.textContent="結果ページへ";go.disabled=false;back.disabled=false;back.textContent="戻る"; // keep same
// クリックが拾われないケース対策（二重バインドOK）
bind(back,close);bind(go,()=>{setTimeout(()=>location.assign(RESULT_URL),0);});
});}catch(e){alert("Bookmarklet error: "+(e&&e.message?e.message:e))}})();
