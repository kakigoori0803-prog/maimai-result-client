<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>maimai Result Client (β)</title>
<style>
 body{background:#0b0f12;color:#e6edf3;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans JP,Helvetica,Arial,sans-serif;line-height:1.6;margin:0}
 .wrap{max-width:900px;margin:32px auto;padding:0 16px}
 h1{font-size:28px;margin:20px 0}
 .card{background:#12171c;border:1px solid #1f2831;border-radius:12px;padding:16px;margin:16px 0}
 label{display:block;font-size:14px;margin:8px 0 6px;color:#9fb3c8}
 input[type=text],textarea{width:100%;background:#0e141a;border:1px solid #27323d;border-radius:10px;color:#e6edf3;padding:12px 14px;font-size:15px;box-sizing:border-box}
 textarea{min-height:240px;white-space:pre-wrap}
 .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
 .btn{cursor:pointer;border:1px solid #2a8; background:#1aa4a4;color:#fff;border-radius:999px;padding:10px 16px;font-weight:700}
 .btn.sec{background:#26313c;border-color:#364656}
 .pill{display:inline-block;background:#1e2630;color:#9fb3c8;border:1px solid #2b3947;border-radius:999px;padding:4px 10px;margin-right:6px}
 .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
 .ok{color:#3bd67f}.warn{color:#f6d365}.err{color:#ff6b6b}
 .small{font-size:12px;color:#9fb3c8}
 .hr{height:1px;background:#1f2831;margin:16px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>maimai Result Client (β)</h1>

  <div class="card">
    <div class="pill" id="badge">待機中</div>
    <span class="small">① まいまい履歴 HTML を渡す（ブックマーク推奨） → ② 確認 → ③ API送信</span>
  </div>

  <div class="card">
    <label>あなたのユーザーID（自動生成）</label>
    <div class="row">
      <input id="uid" type="text" readonly>
      <button class="btn sec" id="regen">再生成</button>
    </div>
  </div>

  <div class="card">
    <label>元ページURL（ブックマークレット経由で自動入力）</label>
    <input id="srcUrl" type="text" placeholder="https://maimaidx.jp/...">
    <div class="small" style="margin-top:6px">履歴一覧 <code class="mono">/maimai-mobile/record/</code> でも、各曲の詳細 <code class="mono">/playlogDetail/</code> でもOK。ブックマークレットを使うと <b>URL と HTML が自動入力</b>されます。</div>
    <div class="hr"></div>
    <label>ここに maimai のプレイ履歴ページの HTML 全体を貼り付け（ブックマーク実行なら自動）</label>
    <textarea id="html"></textarea>
    <div class="row">
      <button class="btn sec" id="checkBtn">内容チェック（簡易）</button>
      <button class="btn" id="sendBtn">API へ送信</button>
    </div>
    <pre id="log" class="mono" style="margin-top:12px"></pre>
  </div>

  <div class="card">
    <label>現在のAPI設定（自動）</label>
    <div class="mono small">API URL: <span id="apiUrlTxt"></span><br>Bearer Token: <span id="tokTxt"></span><br>※ 初回に自動保存（localStorage）。配布先でも入力不要で使えます。</div>
  </div>
</div>

<script>
(() => {
  // ====== 固定設定（公開してOKなトークン）======
  const API_URL = 'https://maimai-result.onrender.com/ingest';
  const PUBLIC_TOKEN = '677212069901c46a68a76e31ad8ba32a';

  // ====== DOM ======
  const $ = (s)=>document.querySelector(s);
  const srcUrlEl = $('#srcUrl');
  const htmlEl   = $('#html');
  const logEl    = $('#log');
  const badge    = $('#badge');
  const uidEl    = $('#uid');
  const apiUrlTxt= $('#apiUrlTxt');
  const tokTxt   = $('#tokTxt');

  // ====== ユーザーID（自動）======
  const loadUid = () => localStorage.getItem('client_uid') || (localStorage.setItem('client_uid',crypto.randomUUID()), localStorage.getItem('client_uid'));
  const setUid  = (v)=>{ localStorage.setItem('client_uid', v); uidEl.value=v; };
  setUid(loadUid());
  $('#regen').onclick = ()=> setUid(crypto.randomUUID());

  // ====== API設定の自動保存 ======
  localStorage.setItem('api_url', API_URL);
  localStorage.setItem('api_token', PUBLIC_TOKEN);
  apiUrlTxt.textContent = API_URL;
  tokTxt.textContent    = PUBLIC_TOKEN.slice(0,6)+'…'+PUBLIC_TOKEN.slice(-4);

  // ====== window.name 経由ペイロード受取（一覧・詳細どちらも対応）======
  let batch = null; // [{url, html},...]
  if (window.name && window.name.startsWith('MAI:')) {
    try {
      const raw = window.name.slice(4);
      const payload = JSON.parse(decodeURIComponent(escape(atob(raw))));
      if (payload && Array.isArray(payload.items) && payload.items.length) {
        batch = payload.items;
        srcUrlEl.value = payload.listUrl || payload.items[0]?.url || '';
        htmlEl.value = (payload.items[0]?.html || '');
        badge.textContent = `受け取り: ${payload.items.length}件`;
        badge.classList.add('ok');
      }
    } catch(e) {
      console.warn(e);
      badge.textContent = '受け取り失敗';
      badge.classList.add('err');
    } finally {
      // もう使わないので消しておく
      window.name = '';
    }
  } else {
    badge.textContent = '待機中';
  }

  // ====== 簡易チェック ======
  $('#checkBtn').onclick = () => {
    let count = 0;
    if (batch && batch.length) count = batch.length;
    else if ((htmlEl.value||'').trim()) count = 1;
    logEl.textContent = `抽出対象の想定件数: ${count}\n（一覧なら件数>0になるはず。0 のときは一覧以外のページ or HTML未入力）`;
  };

  // ====== API送信 ======
  $('#sendBtn').onclick = async () => {
    try {
      const uid = uidEl.value.trim();
      let items = [];
      if (batch && batch.length) {
        items = batch;
      } else {
        const u = srcUrlEl.value.trim();
        const h = htmlEl.value.trim();
        if (!u || !h) { logEl.textContent='[ERROR] URL と HTML を入れてください。'; return; }
        items = [{url:u, html:h}];
      }
      logEl.textContent = '送信中…';

      const body = JSON.stringify({ uid, items });
      const res  = await fetch(API_URL, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer '+PUBLIC_TOKEN
        },
        body
      });
      const text = await res.text();
      let pretty = text;
      try { pretty = JSON.stringify(JSON.parse(text), null, 2) } catch{}
      logEl.textContent = `API status: ${res.status} (${res.ok?'OK':'NG'})\n---\n${pretty}`;
    } catch(e) {
      logEl.textContent = '[ERROR] '+e;
    }
  };
})();
</script>
</body>
</html>
