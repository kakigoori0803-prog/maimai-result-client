<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>maimai Result Client (β)</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", system-ui, sans-serif;
           margin: 0; background:#0f1115; color:#eaeef5; }
    header { padding:16px 20px; border-bottom:1px solid #222937; }
    header h1 { margin:0 0 6px; font-size:22px; }
    header .steps { opacity:.8; font-size:13px; }
    main { padding: 20px; max-width: 980px; margin: 0 auto; }

    section { background:#141826; border:1px solid #222937; border-radius:12px; padding:18px;
              margin: 0 0 18px; }
    h2 { margin:0 0 14px; font-size:20px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow { flex:1 1 auto; min-width: 260px; }
    input, textarea { width:100%; background:#0e1220; color:#eaeef5; border:1px solid #222937;
                      border-radius:10px; padding:12px 14px; font-size:15px; }
    textarea { min-height: 260px; line-height: 1.5; }
    .btn { appearance:none; border:0; border-radius: 999px; padding:12px 18px; cursor:pointer;
           background:#2dd4bf; color:#091014; font-weight:700; font-size:14px; }
    .btn.secondary { background:#2f3651; color:#eaeef5; }
    .btn.warn { background:#f97316; color:#0a0a0a; }
    .hint { font-size:12px; opacity:.8; margin-top:6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .card { background:#0e1220; border:1px dashed #263049; padding:12px; border-radius:10px; }
    .ok { color:#22c55e; } .ng { color:#ef4444; } .muted{opacity:.7}
    .grid { display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    .preview { white-space:pre-wrap; font-family: ui-monospace, Menlo, Consolas, monospace;
               background:#0b0f1a; border:1px solid #222937; padding:10px; border-radius:8px;}
  </style>
</head>
<body>
  <header>
    <h1>maimai Result Client</h1>
    <div class="steps">① まいまい履歴 HTML を渡す（<b>ブックマークレット推奨</b>） → ② 解析 → ③ API送信（<span class="muted">設定＆ユーザーIDは自動</span>）</div>
  </header>
  <main>
    <section id="sec-id">
      <h2>ユーザーID</h2>
      <div class="row">
        <div class="grow">
          <div class="hint">あなたのID（自動）</div>
          <input id="userId" class="mono" readonly>
        </div>
        <div class="grow">
          <div class="hint">Sync Code（任意・複数端末で同じIDに）</div>
          <input id="syncCode" class="mono" placeholder="複数端末で同じIDに">
        </div>
        <div>
          <button id="saveSync" class="btn secondary">Sync Code を保存</button>
        </div>
      </div>
      <div class="hint">※未入力なら自動ID（UUID）を使います。端末間で共有したい場合のみ Sync Code を保存。</div>
    </section>

    <section id="sec-html">
      <h2>HTML 貼り付け</h2>
      <div class="row">
        <div class="grow">
          <div class="hint">元ページURL（ブックマークレット経由で自動入力）</div>
          <input id="sourceUrl" class="mono" placeholder="https://maimaidx.jp/...">
        </div>
        <div>
          <button id="fillWarn" class="btn warn">詳細ページで実行してね</button>
        </div>
      </div>
      <div class="hint">ここに <b>maimai のプレイ履歴「詳細」ページ</b>の HTML 全体を貼り付け（ブックマークレットなら自動で入ります）</div>
      <textarea id="html"></textarea>
      <div class="row" style="margin-top:12px">
        <button id="btnCheck" class="btn secondary">内容チェック（簡易）</button>
        <button id="btnSend" class="btn">API へ送信</button>
      </div>
      <div id="checkOut" class="preview" style="margin-top:10px"></div>
      <div id="sendOut" class="preview" style="margin-top:10px"></div>
    </section>

    <section id="sec-api">
      <h2>現在のAPI設定（自動）</h2>
      <div class="grid">
        <div class="card">
          <div class="hint">API URL</div>
          <div id="currUrl" class="mono"></div>
        </div>
        <div class="card">
          <div class="hint">Bearer Token</div>
          <div id="currTok" class="mono"></div>
        </div>
      </div>
      <div class="hint">※ 初回に自動保存（localStorage）。配布先でも入力不要で使えます。</div>
    </section>
  </main>

  <script>
    // ====== 設定（配布時に埋め込み） ======
    const DEFAULT_API_URL   = "https://maimai-result.onrender.com/ingest";
    const DEFAULT_API_TOKEN = "677212069901c46a68a76e31ad8ba32a"; // 公開OKのトークン（ご提供の value）

    const LS_KEYS = {
      apiUrl:   "mrc.apiUrl",
      apiToken: "mrc.apiToken",
      userId:   "mrc.userId",
      syncCode: "mrc.syncCode"
    };

    // ====== ユーティリティ ======
    const $ = (s)=>document.querySelector(s);
    const fmt = (v)=>v==null?"":String(v);
    const uuid = ()=>crypto.randomUUID();

    function initDefaults() {
      if (!localStorage.getItem(LS_KEYS.apiUrl)) {
        localStorage.setItem(LS_KEYS.apiUrl, DEFAULT_API_URL);
      }
      if (!localStorage.getItem(LS_KEYS.apiToken)) {
        localStorage.setItem(LS_KEYS.apiToken, DEFAULT_API_TOKEN);
      }
      if (!localStorage.getItem(LS_KEYS.userId)) {
        localStorage.setItem(LS_KEYS.userId, uuid());
      }
    }

    function getApiConfig() {
      return {
        url: localStorage.getItem(LS_KEYS.apiUrl) || DEFAULT_API_URL,
        token: localStorage.getItem(LS_KEYS.apiToken) || DEFAULT_API_TOKEN
      };
    }

    function getUserId() {
      const sc = localStorage.getItem(LS_KEYS.syncCode);
      return sc && sc.trim() ? sc.trim() : (localStorage.getItem(LS_KEYS.userId) || uuid());
    }

    function b64DecodeSafe(b64) {
      try { return decodeURIComponent(escape(atob(b64))); } catch { return atob(b64); }
    }
    function b64EncodeSafe(str) {
      try { return btoa(unescape(encodeURIComponent(str))); } catch { return btoa(str); }
    }

    // ====== 受け渡し（window.name） ======
    function tryImportFromWindowName() {
      try {
        if (typeof window.name === "string" && window.name.startsWith("MAI:")) {
          const raw = window.name.slice(4);
          const obj = JSON.parse(b64DecodeSafe(raw));
          if (obj && obj.html) {
            $("#html").value = obj.html;
          }
          if (obj && obj.sourceUrl) {
            $("#sourceUrl").value = obj.sourceUrl;
          }
          // 一度取り込んだら消しておく
          window.name = "";
          // 自動チェック
          setTimeout(() => $("#btnCheck").click(), 0);
        }
      } catch (e) {
        console.warn("window.name import failed:", e);
      }
    }

    // ====== 解析（簡易）— 詳細ページ1件想定 ======
    function parseRecordFromDetail(html, sourceUrl) {
      const dom = new DOMParser().parseFromString(html, "text/html");
      // タイトル候補：入力欄 or よくあるクラス
      const titleCandidates = [
        'input[type="text"]',
        '.music_title','.musicName','.play_musicdata_title','.playlog_top_title',
        '#page .title','.data_title','.name','.song-name'
      ];
      let title = "";
      for (const sel of titleCandidates) {
        const el = dom.querySelector(sel);
        if (el) {
          title = (el.value ?? el.textContent ?? "").trim();
          if (title) break;
        }
      }
      // 達成率（% を含む最大値を拾う）
      let rate = "";
      const txt = dom.body.textContent || "";
      const mAll = txt.match(/(\d{1,3}(?:\.\d{1,4})?)%/g);
      if (mAll && mAll.length) {
        // 数字にして最大のものを採用（画面の大きい数字を想定）
        let max = -1, pick = "";
        for (const s of mAll) {
          const n = parseFloat(s.replace("%",""));
          if (!Number.isNaN(n) && n > max) { max = n; pick = s; }
        }
        rate = pick;
      }
      // 日付時刻
      let playedAt = "";
      const md = txt.match(/20\d{2}\/\d{1,2}\/\d{1,2}\s+\d{1,2}:\d{2}/);
      if (md) playedAt = md[0];

      // 何も取れなければ空配列
      if (!title && !rate && !playedAt) return [];
      return [{
        title, rate, playedAt,
        href: sourceUrl || ""
      }];
    }

    // ====== 画面：内容チェック ======
    $("#btnCheck").addEventListener("click", () => {
      const html = $("#html").value;
      const sourceUrl = $("#sourceUrl").value;
      const out = $("#checkOut");
      out.textContent = "";
      if (!html.trim()) {
        out.innerHTML = '<span class="ng">HTML が空です。</span> ブックマークレットで「詳細ページ」から来るのが楽です。';
        return;
      }
      // 一覧ページ警告
      if (sourceUrl.includes("/maimai-mobile/record/") && !sourceUrl.includes("playlogDetail")) {
        alert("これは『一覧』のHTMLの可能性があります。\n曲の『詳細』ページでブックマークレットを実行してください。");
      }
      const recs = parseRecordFromDetail(html, sourceUrl);
      if (!recs.length) {
        out.innerHTML = '<span class="ng">0 件でした。</span> 詳細ページで試してください。';
        return;
      }
      out.textContent =
        `✔ 解析できた件数: ${recs.length}\n\n` +
        JSON.stringify(recs, null, 2);
    });

    // ====== API送信 ======
    async function sendToApi(records) {
      const {url, token} = getApiConfig();
      const payload = {
        userId: getUserId(),
        records
      };
      const res = await fetch(url, {
        method: "POST",
        mode: "cors",
        headers: {
          "Content-Type": "text/plain",        // プリフライト回避 & サーバ側で受理
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      let json = {};
      try { json = JSON.parse(text); } catch { /* noop */ }
      return { status: res.status, bodyText: text, bodyJson: json };
    }

    $("#btnSend").addEventListener("click", async () => {
      const html = $("#html").value;
      const sourceUrl = $("#sourceUrl").value;
      const out = $("#sendOut");
      out.textContent = "";
      const recs = parseRecordFromDetail(html, sourceUrl);
      if (!recs.length) {
        out.innerHTML = '<span class="ng">送信中止：</span> 解析結果が 0 件です。まず「内容チェック（簡易）」でご確認ください。';
        return;
      }
      out.textContent = "送信中…";
      try {
        const r = await sendToApi(recs);
        out.textContent =
`API status: ${r.status}
---
${r.bodyText}`;
      } catch (e) {
        out.textContent = "送信失敗: " + (e && e.message ? e.message : String(e));
      }
    });

    // ====== Sync Code 保存 ======
    $("#saveSync").addEventListener("click", () => {
      const sc = $("#syncCode").value.trim();
      if (sc) localStorage.setItem(LS_KEYS.syncCode, sc);
      else localStorage.removeItem(LS_KEYS.syncCode);
      $("#userId").value = getUserId();
      alert("保存しました。");
    });

    // ====== 一覧ページ注意ボタン ======
    $("#fillWarn").addEventListener("click", () => {
      const src = $("#sourceUrl").value;
      if (src && src.includes("/maimai-mobile/record/") && !src.includes("playlogDetail")) {
        alert("『一覧』ではなく『詳細』ページで実行してください。");
      } else {
        alert("ブックマークレットを『詳細』ページで実行すると自動入力されます。");
      }
    });

    // ====== 初期化 ======
    initDefaults();
    $("#userId").value = getUserId();
    $("#syncCode").value = localStorage.getItem(LS_KEYS.syncCode) || "";
    const api = getApiConfig();
    $("#currUrl").textContent = api.url;
    $("#currTok").textContent = api.token.replace(/^(.{6}).+(.{4})$/, "$1…$2");
    tryImportFromWindowName();
  </script>
</body>
</html>
