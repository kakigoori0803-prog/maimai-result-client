<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>maimai Result Client (β)</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";background:#0b0b0d;color:#e8e8ea}
    .wrap{max-width:820px;margin:0 auto;padding:20px}
    h1{font-size:28px;margin:12px 0 8px}
    p.lead{opacity:.85;line-height:1.6;margin:4px 0 14px}
    section{background:#141418;border:1px solid #252533;border-radius:12px;padding:14px;margin:14px 0 18px}
    h2{font-size:20px;margin:4px 0 12px}
    .row{display:flex;gap:10px;align-items:center;margin:10px 0;flex-wrap:wrap}
    label{display:block;font-size:12px;opacity:.8;margin:4px 0 6px}
    input[type=text],input[type=url],textarea{width:100%;border-radius:10px;border:1px solid #2a2a3a;background:#0e0e13;color:#e8e8ea;padding:12px 12px;font-size:15px;outline:none}
    textarea{min-height:220px;resize:vertical;line-height:1.5}
    .btn{display:inline-block;border-radius:999px;border:1px solid transparent;padding:10px 16px;font-weight:600;background:#2dd4bf;color:#07231f;cursor:pointer;user-select:none}
    .btn.secondary{background:#232333;color:#e8e8ea;border-color:#303046}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .note{font-size:12px;opacity:.8}
    .pill{display:inline-block;padding:4px 10px;background:#1d1d28;border:1px solid #2a2a3a;border-radius:999px;font-size:12px}
    .muted{opacity:.7}
    pre.log{white-space:pre-wrap;word-break:break-word;background:#0f0f16;border:1px solid #26263a;padding:12px;border-radius:10px;margin:12px 0 0}
    .successBanner{background:#052d22;border:1px solid #0c5a46;border-radius:10px;padding:10px 12px;margin-top:10px;color:#8ef1d6;display:none}
  </style>

  <script>
    // ===== 自動設定（初回） =====
    const DEFAULTS = {
      apiUrl:  'https://maimai-result.onrender.com/ingest',
      apiToken:'677212069901c46a68a76e31ad8ba32a'
    };
    const LS={get:k=>{try{return localStorage.getItem(k)}catch(_){return null}},set:(k,v)=>{try{localStorage.setItem(k,v)}catch(_){}},del:k=>{try{localStorage.removeItem(k)}catch(_){}}};
    function getUserId(){let id=LS.get('mai_user_id');if(!id){id=(crypto&&crypto.randomUUID)?crypto.randomUUID():'uid-'+Math.random().toString(36).slice(2)+Date.now().toString(36);LS.set('mai_user_id',id)}return id}
    function ensureDefaults(){if(!LS.get('apiUrl'))LS.set('apiUrl',DEFAULTS.apiUrl);if(!LS.get('apiToken'))LS.set('apiToken',DEFAULTS.apiToken)}

    // 旧方式（window.name）→ 仕様で消される環境があるため一応残す
    function takeFromWindowName(){
      if(!window.name||window.name.indexOf('MAI:')!==0) return null;
      const b64=window.name.slice(4); try{window.name=''}catch(_){}
      try{const json=decodeURIComponent(escape(atob(b64)));return JSON.parse(json)}catch(_){return null}
    }

    // 受信共通
    function applyPayload(p){
      if(!p) return;
      const src=document.getElementById('srcUrl');
      const ta =document.getElementById('html');
      if(src) src.value=p.sourceUrl||'';
      if(ta)  ta.value =p.html||'';
      const ok=document.getElementById('arrived'); ok.style.display='block';
      setTimeout(()=>ok.style.display='none',3000);
      if(ta){ ta.focus(); ta.scrollIntoView({behavior:'smooth',block:'start'}); }
    }

    // postMessage 受信（新方式）
    window.addEventListener('message', (ev)=>{
      // origin チェックは必要なら ev.origin === location.origin で絞れます
      if(!ev.data||ev.data.type!=='MAI_PAYLOAD') return;
      applyPayload(ev.data.payload);
    }, false);

    document.addEventListener('DOMContentLoaded', ()=>{
      ensureDefaults();
      document.getElementById('userId').value=getUserId();

      // window.name フォールバック
      const p=takeFromWindowName();
      if(p) applyPayload(p);

      // UI: 簡易チェック
      document.getElementById('analyzeBtn').addEventListener('click', ()=>{
        const html=document.getElementById('html').value.trim();
        const src =document.getElementById('srcUrl').value.trim();
        const size=new Blob([html]).size;
        const lines=html?html.split(/\r?\n/).length:0;
        document.getElementById('result').textContent=
          `元URL: ${src||'(未設定)'}\nHTMLサイズ: ${size.toLocaleString()} bytes\n行数目安: ${lines.toLocaleString()} 行\n\n※詳細抽出はサーバー側で行います。`;
      });

      // 送信
      document.getElementById('sendBtn').addEventListener('click', async ()=>{
        const html=document.getElementById('html').value.trim();
        const src =document.getElementById('srcUrl').value.trim();
        if(!html){ alert('HTML が空です。先にブックマークレットを実行してください。'); return; }
        const body={userId:getUserId(),sourceUrl:src||null,html};
        const log=document.getElementById('result'); log.textContent='送信中...';
        document.getElementById('sendBtn').disabled=true;
        try{
          const apiUrl=LS.get('apiUrl')||DEFAULTS.apiUrl;
          const apiToken=LS.get('apiToken')||DEFAULTS.apiToken;
          const res=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiToken},body:JSON.stringify(body)});
          const text=await res.text(); let json=null; try{json=JSON.parse(text)}catch(_){}
          log.textContent=`API status: ${res.status} ${res.ok?'(OK)':'(NG)'}\n---\n${json?JSON.stringify(json,null,2):text}`;
          if(res.ok){const b=document.getElementById('arrivedOk');b.style.display='block';setTimeout(()=>b.style.display='none',3500);}
        }catch(e){log.textContent='送信失敗: '+(e&&e.message?e.message:e)}
        finally{document.getElementById('sendBtn').disabled=false;}
      });

      // Sync Code 保存
      document.getElementById('saveSync').addEventListener('click',()=>{
        const v=document.getElementById('syncCode').value.trim();
        if(v) LS.set('mai_sync_code',v); else LS.del('mai_sync_code');
        const b=document.getElementById('saveSync'); const old=b.textContent; b.textContent='保存しました'; setTimeout(()=>b.textContent=old,1200);
      });

      // 現在設定を表示
      document.getElementById('apiUrlView').textContent=LS.get('apiUrl');
      const tk=LS.get('apiToken')||''; document.getElementById('tokenView').textContent=tk?tk.slice(0,6)+'•••'+tk.slice(-4):'(未設定)';
    });
  </script>
</head>
<body>
  <div class="wrap">
    <h1>maimai Result Client (β)</h1>
    <p class="lead">① まいまい履歴 HTML を渡す（<span class="pill">ブックマークレット推奨</span>） → ② 解析 → ③ API送信（設定&ユーザーIDは自動）</p>

    <div id="arrivedOk" class="successBanner">✅ APIへ送信しました</div>
    <div id="arrived"   class="successBanner" style="display:none">✅ ブックマークレットのデータを受け取りました</div>

    <section>
      <h2>ユーザーID</h2>
      <div class="row">
        <div style="flex:1">
          <label>あなたのID（自動）</label>
          <input id="userId" type="text" readonly>
        </div>
      </div>
      <div class="note" style="margin:8px 0 12px">
        未入力の端末では自動ID（UUID）を使います。端末間で共有したい場合は下の Sync Code を利用してください。
      </div>
      <div class="row">
        <input id="syncCode" type="text" placeholder="複数端末で同じIDに" style="flex:1">
        <button id="saveSync" class="btn secondary">Sync Code を保存</button>
        <button class="btn secondary" onclick="localStorage.removeItem('mai_user_id');location.reload()">削除</button>
      </div>
    </section>

    <section id="paste">
      <h2>HTML 貼り付け</h2>
      <label>元ページURL（ブックマークレット経由で自動入力）</label>
      <input id="srcUrl" type="url" placeholder="https://maimaidx.jp/..." readonly>
      <label style="margin-top:10px">ここに maimai のプレイ履歴ページの HTML 全体を貼り付け（ブックマークレット実行で自動入力）</label>
      <textarea id="html" placeholder="ブックマークレット実行で自動入力されます。"></textarea>
      <div class="row">
        <button id="analyzeBtn" class="btn secondary">内容チェック（簡易）</button>
        <button id="sendBtn" class="btn">API へ送信</button>
      </div>
      <pre id="result" class="log"></pre>
    </section>

    <section>
      <h2>現在のAPI設定（自動）</h2>
      <div class="note">API URL: <span id="apiUrlView" class="muted"></span><br>Bearer Token: <span id="tokenView" class="muted"></span></div>
      <div class="note" style="margin-top:8px">※ 初回に自動保存（localStorage）。配布先でも入力不要で使えます。</div>
    </section>
  </div>
</body>
</html>
