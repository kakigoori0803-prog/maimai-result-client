<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>maimai Result Client (β)</title>
  <style>
    :root{color-scheme:dark light}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";margin:0;background:#0b0b0e;color:#e9e9ef}
    .wrap{max-width:980px;margin:0 auto;padding:24px 16px}
    h1{font-size:28px;margin:0 0 8px}
    h2{font-size:20px;margin:28px 0 12px}
    .card{background:#141418;border:1px solid #2a2a33;border-radius:12px;padding:16px;margin:16px 0}
    label{display:block;font-size:13px;opacity:.85;margin:.35rem 0 .25rem}
    input,textarea,button{font:inherit}
    input,textarea{width:100%;background:#0f0f13;border:1px solid #2a2a33;border-radius:10px;color:#e9e9ef;padding:10px 12px}
    textarea{min-height:220px;resize:vertical;line-height:1.45}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    .btn{display:inline-flex;gap:.5rem;align-items:center;background:#1f6feb;border:1px solid #1b62d4;padding:10px 14px;border-radius:999px;color:#fff;cursor:pointer}
    .btn.secondary{background:#2a2a33;border-color:#3a3a45}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #2a2a33;padding:10px;text-align:left;font-size:14px}
    code,pre{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .muted{opacity:.8}
    .ok{color:#6ee7a8}
    .warn{color:#facc15}
    .err{color:#f87171}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>maimai Result Client (β)</h1>
    <p class="muted">① プレイ履歴ページの HTML を丸ごと貼り付け → ② 解析 → ③ 必要なら API 送信</p>

    <!-- API 設定 -->
    <div class="card">
      <h2>API 設定（任意）</h2>
      <div class="row">
        <div>
          <label for="apiUrl">API URL</label>
          <input id="apiUrl" type="url" placeholder="https://example.com/ingest"
                 value="https://maimai-result.onrender.com/ingest" />
        </div>
        <div>
          <label for="token">Bearer Token（あれば）</label>
          <input id="token" type="text" placeholder="例: 12345..." />
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="saveSettings" class="btn">設定を保存</button>
        <button id="clearSettings" class="btn secondary">保存した設定を削除</button>
        <span id="saveMsg" class="muted"></span>
      </div>
    </div>

    <!-- HTML 貼り付け -->
    <div class="card">
      <h2>HTML 貼り付け</h2>
      <label for="sourceUrl">元ページのURL（自動入力されます）</label>
      <input id="sourceUrl" type="url" placeholder="https://maimaidx.jp/..." />
      <label for="htmlInput">ここに maimai のプレイ履歴ページの HTML を貼り付け</label>
      <textarea id="htmlInput" placeholder="ページ全体のHTMLをペースト"></textarea>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="analyze" class="btn">解析する</button>
        <span id="parseMsg" class="muted"></span>
      </div>
    </div>

    <!-- 解析結果 -->
    <div class="card">
      <h2>解析結果</h2>
      <div id="resultWrap" class="muted">まだ結果はありません。</div>
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="sendApi" class="btn" disabled>APIへ送信</button>
        <span id="apiMsg" class="muted"></span>
      </div>
    </div>

    <!-- ブックマークレット（任意） -->
    <div class="card">
      <h2>ブックマークレット（任意）</h2>
      <p class="muted">このページに HTML を自動で送り込む用。Safari でブックマークに追加し、URL欄に以下を貼り付け。</p>
      <pre id="bmCode" style="white-space:pre-wrap"></pre>
      <button id="copyBm" class="btn secondary">コードをコピー</button>
    </div>
  </div>

  <script>
    /********** 設定の保存/復元 **********/
    const $ = (sel, root=document) => root.querySelector(sel);
    const apiUrlEl = $('#apiUrl');
    const tokenEl  = $('#token');
    const srcEl    = $('#sourceUrl');
    const htmlEl   = $('#htmlInput');
    const analyzeBtn = $('#analyze');
    const parseMsg = $('#parseMsg');
    const resultWrap = $('#resultWrap');
    const sendBtn = $('#sendApi');
    const apiMsg = $('#apiMsg');
    const saveMsg = $('#saveMsg');

    function loadSettings(){
      const s = localStorage.getItem('mrc_settings');
      if(!s) return;
      try{
        const { apiUrl, token } = JSON.parse(s);
        if(apiUrl) apiUrlEl.value = apiUrl;
        if(token)  tokenEl.value  = token;
      }catch(_){}
    }
    function saveSettings(){
      const value = JSON.stringify({ apiUrl: apiUrlEl.value.trim(), token: tokenEl.value.trim() });
      localStorage.setItem('mrc_settings', value);
      saveMsg.textContent = '保存しました。';
      setTimeout(()=> saveMsg.textContent = '', 2000);
    }
    function clearSettings(){
      localStorage.removeItem('mrc_settings');
      tokenEl.value = '';
      saveMsg.textContent = '削除しました。';
      setTimeout(()=> saveMsg.textContent = '', 2000);
    }
    $('#saveSettings').addEventListener('click', saveSettings);
    $('#clearSettings').addEventListener('click', clearSettings);
    loadSettings();

    /********** 解析ロジック **********/
    function parseMaimaiHtml(html) {
      // ★必要に応じてここをあなたの既存ロジックに差し替えてOK
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const items = [];

      // できるだけ多くのレイアウトに当たる“ゆるめ”の探索
      // 各カードっぽい要素を拾う
      const candidates =
        Array.from(doc.querySelectorAll('.playlog, .record, .box, section, article, div'))
          .filter(el => /ACHIEVEMENT|TRACK|S[SP]{0,2}\+?|MASTER|BASIC|EXPERT|ADVANCED/i.test(el.textContent||''))
          .slice(0, 50);

      for (const el of candidates) {
        // タイトル候補
        let title =
          (el.querySelector('.music_name,.music-title,.playlog_music_title')||{}).textContent
          || (el.querySelector('input[type="text"][value]')||{}).value
          || (el.querySelector('h3,h4,header strong')||{}).textContent
          || '';

        title = (title||'').trim().replace(/\s+/g,' ');
        if (!title) continue;

        // レート（%）
        let rateText = '';
        const rateNode = el.querySelector('.rate,.achievement,.achi,.percent');
        if (rateNode) rateText = rateNode.textContent;
        if (!rateText) {
          const m = (el.textContent||'').match(/(\d{2,3}\.\d{3})\s*%/);
          if (m) rateText = m[1];
        }
        const rate = rateText ? Number(rateText.replace(/[^\d.]/g,'')) : null;

        // プレイ日時
        let playedAt = '';
        const dateNode = el.querySelector('.date,.playedAt,.time,.played_date');
        if (dateNode) playedAt = dateNode.textContent;
        if (!playedAt) {
          const m = (el.textContent||'').match(/(\d{4}\/\d{2}\/\d{2}\s+\d{2}:\d{2})/);
          if (m) playedAt = m[1];
        }
        playedAt = (playedAt||'').trim();

        items.push({ title, rate, playedAt });
      }

      // 何も取れない場合はページ全体から1件でも拾う
      if (!items.length) {
        const mTitle = (doc.body.textContent||'').match(/["“”'‘’]?([\w\s\-\!\?\&\.\u3000-\u30ff\u4e00-\u9faf]{3,})["“”'‘’]?\s+ACHIEVEMENT/i);
        const mRate  = (doc.body.textContent||'').match(/(\d{2,3}\.\d{3})\s*%/);
        const mDate  = (doc.body.textContent||'').match(/(\d{4}\/\d{2}\/\d{2}\s+\d{2}:\d{2})/);
        if (mTitle || mRate || mDate) {
          items.push({
            title: (mTitle?mTitle[1]:'(unknown)').trim(),
            rate:  mRate?Number(mRate[1]):null,
            playedAt: mDate?mDate[1]:''
          });
        }
      }

      return items;
    }

    function renderResults(items){
      if (!items || !items.length){
        resultWrap.innerHTML = '<span class="muted">解析結果が空でした。</span>';
        sendBtn.disabled = true;
        return;
      }
      let html = `<div class="muted">${items.length}件解析しました。</div>
      <table><thead><tr><th>#</th><th>Title</th><th>Rate</th><th>PlayedAt</th></tr></thead><tbody>`;
      items.forEach((it, i)=>{
        html += `<tr>
          <td>${i+1}</td>
          <td>${escapeHtml(it.title||'')}</td>
          <td>${it.rate!=null ? it.rate.toFixed(3)+'%' : '-'}</td>
          <td>${escapeHtml(it.playedAt||'')}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      resultWrap.innerHTML = html;
      sendBtn.disabled = false;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    }

    analyzeBtn.addEventListener('click', ()=>{
      parseMsg.textContent = '';
      const raw = htmlEl.value.trim();
      if(!raw){ parseMsg.textContent = 'HTMLが空です。'; return; }
      try{
        const items = parseMaimaiHtml(raw);
        renderResults(items);
      }catch(e){
        console.error(e);
        parseMsg.textContent = '解析エラー: ' + e.message;
      }
    });

    /********** API 送信 **********/
    sendBtn.addEventListener('click', async ()=>{
      apiMsg.textContent = '';
      const apiUrl = apiUrlEl.value.trim();
      if(!apiUrl){ apiMsg.textContent = 'API URL が未設定です。'; return; }
      // 直前の描画から再収集（簡易）
      const items = Array.from(resultWrap.querySelectorAll('tbody tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        return {
          title: tds[1].textContent.trim(),
          rate:  (tds[2].textContent.replace('%','')||'').trim()? Number(tds[2].textContent.replace('%','')): null,
          playedAt: tds[3].textContent.trim()
        };
      });
      if(!items.length){ apiMsg.textContent = '送信対象がありません。'; return; }

      const body = { sourceUrl: srcEl.value.trim()||null, items };
      const headers = { 'Content-Type':'application/json' };
      const token = tokenEl.value.trim();
      if (token) headers['Authorization'] = 'Bearer ' + token;

      try{
        const res = await fetch(apiUrl, { method:'POST', headers, body: JSON.stringify(body) });
        const txt = await res.text();
        apiMsg.innerHTML = res.ok ? `<span class="ok">OK</span> ${escapeHtml(txt)}` : `<span class="err">HTTP ${res.status}</span> ${escapeHtml(txt)}`;
      }catch(e){
        apiMsg.innerHTML = `<span class="err">送信失敗:</span> ${escapeHtml(e.message)}`;
      }
    });

    /********** ブックマークレット生成 **********/
    function makeBookmarklet(){
      const dest = location.origin + location.pathname.replace(/index\.html?$/,'');
      const url = dest.endsWith('/')? dest : dest + '/';
      const code = `
javascript:(()=>{try{const DEST='${url}';const data={html:document.documentElement.outerHTML,sourceUrl:location.href};window.name='MAI:'+btoa(unescape(encodeURIComponent(JSON.stringify(data))));location.href=DEST;}catch(e){alert('Bookmarklet error: '+(e&&e.message?e.message:e));}})();
`.trim();
      return code;
    }
    const bm = makeBookmarklet();
    $('#bmCode').textContent = bm;
    $('#copyBm').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(bm); $('#copyBm').textContent='コピーしました'; setTimeout(()=>{$('#copyBm').textContent='コードをコピー'},1500);}catch(_){}
    });

    /********** 受信（ブックマークレットから自動貼り付け&解析） **********/
    (function () {
      function decodePayload(b64) {
        try { return decodeURIComponent(escape(atob(b64))); } catch (_) { return atob(b64); }
      }
      function run() {
        try {
          const PREFIX = 'MAI:';
          if (!window.name || typeof window.name !== 'string' || !window.name.startsWith(PREFIX)) return;

          // 受け取り → 復号 → JSON化
          const json = decodePayload(window.name.slice(PREFIX.length));
          const payload = JSON.parse(json || '{}');  // { html, sourceUrl }

          // 再訪時の誤動作防止
          window.name = '';

          if (payload.sourceUrl) { srcEl.value = payload.sourceUrl; }
          if (payload.html)      { htmlEl.value = payload.html; htmlEl.dispatchEvent(new Event('input', {bubbles:true})); }

          // 自動で解析まで
          if (payload.html) analyzeBtn.click();
        } catch (e) {
          console.error(e);
          alert('受信処理でエラー: ' + e.message);
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => setTimeout(run, 0));
      } else {
        setTimeout(run, 0);
      }
    })();
  </script>
</body>
</html>
