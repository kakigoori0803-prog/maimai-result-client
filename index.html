<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>maimai Result Client (β)</title>
<style>
  :root{--c-bg:#0b0f12;--c-card:#12171c;--c-txt:#e8f0f5;--c-sub:#a7b6c2;--c-ac:#1dd1b9;--c-gray:#2d3842}
  html,body{background:var(--c-bg);color:var(--c-txt);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:880px;margin:24px auto;padding:0 14px}
  h1{font-size:28px;margin:8px 0 18px}
  .card{background:var(--c-card);border-radius:14px;padding:18px;margin:18px 0;box-shadow:0 4px 20px rgba(0,0,0,.3)}
  h2{font-size:20px;margin:0 0 12px}
  label{display:block;font-size:13px;color:var(--c-sub);margin:14px 0 6px}
  input,textarea{width:100%;box-sizing:border-box;background:#0e1317;border:1px solid #22303b;border-radius:10px;padding:12px 14px;color:var(--c-txt);outline:none}
  textarea{min-height:220px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;cursor:pointer}
  .btn.ac{background:var(--c-ac);color:#00231e}
  .btn.gray{background:var(--c-gray);color:#cfe1eb}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .help{font-size:12px;color:var(--c-sub);margin-top:8px;line-height:1.6}
  .kbd{display:inline-block;padding:2px 6px;border-radius:6px;background:#1b242c;border:1px solid #273440;font-size:12px}
  .copybox{display:flex;gap:8px;margin-top:8px}
  .copybox input{flex:1}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0e1419;border:1px solid #24313c;color:#9cb0be;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>maimai Result Client (β)</h1>

  <div class="card">
    <h2>設定（自動保存）</h2>
    <label>API URL</label>
    <input id="apiUrl" class="mono" placeholder="https://maimai-result.onrender.com/ingest">
    <label>Bearer Token</label>
    <input id="apiToken" class="mono" placeholder="例: 12345...">
    <div class="row" style="margin-top:12px">
      <button id="save" class="btn ac">設定を保存</button>
      <button id="clear" class="btn gray">保存した設定を削除</button>
    </div>
    <p class="help">※ 初回アクセス時にローカルへ自動保存されます（<span class="kbd">localStorage</span>）。配布先でも入力不要。</p>
    <div style="margin-top:10px">
      <span class="pill" id="now">現在のAPI設定 — 読み込み中…</span>
    </div>
  </div>

  <div class="card">
    <h2>ブックマークレット</h2>
    <p class="help">下のコードを「ブックマークのURL」に貼り付けてください（名前は自由）。</p>
    <div class="copybox">
      <input id="bm" class="mono" readonly>
      <button id="copy" class="btn gray">コピー</button>
    </div>
    <p class="help">動作：履歴一覧で実行すると、自動で最下部まで読み込み→詳細をすべて取得→APIへ順次送信→完了後「結果ページへ」。</p>
  </div>

  <div class="card">
    <h2>HTML 貼り付け（手動モード）</h2>
    <label>元ページURL（手動入力時のメモに使います）</label>
    <input id="srcUrl" class="mono" placeholder="https://maimaidx.jp/maimai-mobile/record/...">
    <label>ここに maimai のプレイ履歴ページの HTML 全体を貼り付け</label>
    <textarea id="html"></textarea>
    <div class="row" style="margin-top:12px">
      <button id="check" class="btn gray">内容チェック（簡易）</button>
      <button id="post" class="btn ac">API へ送信</button>
    </div>
    <div class="help" id="log"></div>
  </div>
</div>

<script>
(function(){
  const DEFAULT_API   = 'https://maimai-result.onrender.com/ingest';
  const DEFAULT_TOKEN = '677212069901c46a68a76e31ad8ba32a'; // 公開用トークン（配布向け）

  const $=id=>document.getElementById(id);
  const apiUrl   = $('apiUrl');
  const apiToken = $('apiToken');
  const now      = $('now');
  const bmInput  = $('bm');
  const srcUrl   = $('srcUrl');
  const htmlTA   = $('html');
  const logBox   = $('log');

  // 設定ロード
  function load(){
    const u = localStorage.getItem('mrc.apiUrl') || DEFAULT_API;
    const t = localStorage.getItem('mrc.token')  || DEFAULT_TOKEN;
    apiUrl.value = u; apiToken.value = t;
    now.textContent = `現在のAPI設定 — ${u}  /  Bearer: ${t.slice(0,6)}…${t.slice(-4)}`;
    // ブックマークレット生成
    const src = 'https://kakigoori0803-prog.github.io/maimai-result-client/mrc.js?v=8';
    bmInput.value = `javascript:(()=>{try{var s=document.createElement('script');s.src='${src}';document.body.appendChild(s);}catch(e){alert('Bookmarklet error: '+e.message)}})();`;
  }
  load();

  $('save').onclick = ()=>{
    localStorage.setItem('mrc.apiUrl', apiUrl.value.trim() || DEFAULT_API);
    localStorage.setItem('mrc.token',  apiToken.value.trim()|| DEFAULT_TOKEN);
    load();
  };
  $('clear').onclick = ()=>{
    localStorage.removeItem('mrc.apiUrl');
    localStorage.removeItem('mrc.token');
    load();
  };
  $('copy').onclick = async()=>{
    try{await navigator.clipboard.writeText(bmInput.value); $('copy').textContent='コピーしました'; setTimeout(()=>$('copy').textContent='コピー',1400);}catch(e){alert('コピーできませんでした');}
  };

  $('check').onclick = ()=>{
    const html = htmlTA.value.trim();
    if(!html){ logBox.textContent='HTMLが空です'; return; }
    logBox.textContent = `文字数: ${html.length.toLocaleString()} / URL: ${srcUrl.value||'(未入力)'}`;
  };

  $('post').onclick = async()=>{
    const url = (localStorage.getItem('mrc.apiUrl')||DEFAULT_API).trim();
    const tok = (localStorage.getItem('mrc.token') ||DEFAULT_TOKEN).trim();
    const payload = { url: srcUrl.value||'', html: htmlTA.value||'', ts: Date.now() };
    try{
      const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+tok},body:JSON.stringify(payload)});
      const j = await res.json().catch(()=>({}));
      logBox.textContent = `API status: ${res.status} ${res.ok?'(OK)':'(NG)'} — ${JSON.stringify(j)}`;
    }catch(e){
      logBox.textContent = '送信失敗: '+e.message;
    }
  };
})();
</script>
</body>
</html>
