<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>maimai Result Client (β)</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", system-ui, sans-serif;
           margin: 0; background:#0f1115; color:#eaeef5; }
    header { padding:16px 20px; border-bottom:1px solid #222937; }
    header h1 { margin:0 0 6px; font-size:22px; }
    header .steps { opacity:.8; font-size:13px; }
    main { padding: 20px; max-width: 980px; margin: 0 auto; }
    section { background:#141826; border:1px solid #222937; border-radius:12px; padding:18px; margin: 0 0 18px; }
    h2 { margin:0 0 14px; font-size:20px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow { flex:1 1 auto; min-width: 260px; }
    input, textarea { width:100%; background:#0e1220; color:#eaeef5; border:1px solid #222937;
                      border-radius:10px; padding:12px 14px; font-size:15px; }
    textarea { min-height: 260px; line-height: 1.5; }
    .btn { appearance:none; border:0; border-radius: 999px; padding:12px 18px; cursor:pointer;
           background:#2dd4bf; color:#091014; font-weight:700; font-size:14px; }
    .btn.secondary { background:#2f3651; color:#eaeef5; }
    .btn.warn { background:#f97316; color:#0a0a0a; }
    .hint { font-size:12px; opacity:.8; margin-top:6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .card { background:#0e1220; border:1px dashed #263049; padding:12px; border-radius:10px; }
    .ok { color:#22c55e; } .ng { color:#ef4444; } .muted{opacity:.7}
    .grid { display:grid; gap:10px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    .preview { white-space:pre-wrap; font-family: ui-monospace, Menlo, Consolas, monospace;
               background:#0b0f1a; border:1px solid #222937; padding:10px; border-radius:8px;}
  </style>
</head>
<body>
  <header>
    <h1>maimai Result Client</h1>
    <div class="steps">① 履歴 or 詳細ページでブックマークレット実行 → ② 解析（<b>一覧は複数件</b>） → ③ API送信（<span class="muted">設定＆ユーザーIDは自動</span>）</div>
  </header>
  <main>
    <section id="sec-id">
      <h2>ユーザーID</h2>
      <div class="row">
        <div class="grow">
          <div class="hint">あなたのID（自動）</div>
          <input id="userId" class="mono" readonly>
        </div>
        <div class="grow">
          <div class="hint">Sync Code（任意・複数端末で同じIDに）</div>
          <input id="syncCode" class="mono" placeholder="複数端末で同じIDに">
        </div>
        <div>
          <button id="saveSync" class="btn secondary">Sync Code を保存</button>
        </div>
      </div>
      <div class="hint">※未入力なら自動ID（UUID）を使います。端末間共有したいときのみ Sync Code を保存。</div>
    </section>

    <section id="sec-html">
      <h2>HTML 貼り付け</h2>
      <div class="row">
        <div class="grow">
          <div class="hint">元ページURL（ブックマークレット経由で自動入力）</div>
          <input id="sourceUrl" class="mono" placeholder="https://maimaidx.jp/...">
        </div>
        <div>
          <button id="fillWarn" class="btn warn">ヒント</button>
        </div>
      </div>
      <div class="hint">
        履歴一覧 <code>/maimai-mobile/record/</code> でも、各曲の詳細 <code>/playlogDetail/</code> でもOK。<br>
        ブックマークレットなら HTML は自動入力されます。
      </div>
      <textarea id="html"></textarea>
      <div class="row" style="margin-top:12px">
        <button id="btnCheck" class="btn secondary">内容チェック</button>
        <button id="btnSend" class="btn">API へ送信</button>
      </div>
      <div id="checkOut" class="preview" style="margin-top:10px"></div>
      <div id="sendOut" class="preview" style="margin-top:10px"></div>
    </section>

    <section id="sec-api">
      <h2>現在のAPI設定（自動）</h2>
      <div class="grid">
        <div class="card">
          <div class="hint">API URL</div>
          <div id="currUrl" class="mono"></div>
        </div>
        <div class="card">
          <div class="hint">Bearer Token</div>
          <div id="currTok" class="mono"></div>
        </div>
      </div>
      <div class="hint">※ 初回に自動保存（localStorage）。配布先でも入力不要です。</div>
    </section>
  </main>

  <script>
    // ====== 固定設定（配布時に埋め込み） ======
    const DEFAULT_API_URL   = "https://maimai-result.onrender.com/ingest";
    const DEFAULT_API_TOKEN = "677212069901c46a68a76e31ad8ba32a";

    const LS_KEYS = {
      apiUrl:   "mrc.apiUrl",
      apiToken: "mrc.apiToken",
      userId:   "mrc.userId",
      syncCode: "mrc.syncCode"
    };

    // ====== ユーティリティ ======
    const $ = (s)=>document.querySelector(s);
    const uuid = ()=>crypto.randomUUID();
    const fmt = (v)=>v==null?"":String(v);

    function initDefaults() {
      if (!localStorage.getItem(LS_KEYS.apiUrl))   localStorage.setItem(LS_KEYS.apiUrl, DEFAULT_API_URL);
      if (!localStorage.getItem(LS_KEYS.apiToken)) localStorage.setItem(LS_KEYS.apiToken, DEFAULT_API_TOKEN);
      if (!localStorage.getItem(LS_KEYS.userId))   localStorage.setItem(LS_KEYS.userId, uuid());
    }
    function getApiConfig() {
      return {
        url: localStorage.getItem(LS_KEYS.apiUrl)   || DEFAULT_API_URL,
        token: localStorage.getItem(LS_KEYS.apiToken) || DEFAULT_API_TOKEN
      };
    }
    function getUserId() {
      const sc = (localStorage.getItem(LS_KEYS.syncCode)||"").trim();
      return sc || localStorage.getItem(LS_KEYS.userId) || uuid();
    }

    function b64DecodeSafe(b64) { try { return decodeURIComponent(escape(atob(b64))); } catch { return atob(b64); } }
    function b64EncodeSafe(str)  { try { return btoa(unescape(encodeURIComponent(str))); } catch { return btoa(str); } }

    // ====== 受け渡し取り込み ======
    function tryImportFromWindowName() {
      try {
        if (typeof window.name === "string" && window.name.startsWith("MAI:")) {
          const raw = window.name.slice(4);
          const obj = JSON.parse(b64DecodeSafe(raw));
          if (obj && obj.html)      $("#html").value = obj.html;
          if (obj && obj.sourceUrl) $("#sourceUrl").value = obj.sourceUrl;
          window.name = "";
          setTimeout(()=>$("#btnCheck").click(),0);
        }
      } catch(e) { console.warn(e); }
    }

    // ====== 共通：% 最大値・日時抽出 ======
    function extractMaxPercent(text) {
      const m = text.match(/(\d{1,3}(?:\.\d{1,4})?)%/g);
      if (!m) return "";
      let best = -1, out = "";
      for (const s of m) { const v = parseFloat(s); if (!Number.isNaN(v) && v > best) { best=v; out=s; } }
      return out;
    }
    function extractDateTime(text) {
      const m = text.match(/20\d{2}\/\d{1,2}\/\d{1,2}\s+\d{1,2}:\d{2}/);
      return m ? m[0] : "";
    }

    // ====== 詳細ページ 1件抽出 ======
    function parseRecordsFromDetail(html, sourceUrl) {
      const dom = new DOMParser().parseFromString(html,"text/html");
      const titleSel = [
        'input[type="text"]','.music_title','.musicName','.play_musicdata_title',
        '.playlog_top_title','#page .title','.data_title','.name','.song-name'
      ];
      let title = "";
      for (const sel of titleSel) {
        const el = dom.querySelector(sel);
        if (el) { title = (el.value ?? el.textContent ?? "").trim(); if (title) break; }
      }
      const text = dom.body.textContent || "";
      const rate = extractMaxPercent(text);
      const playedAt = extractDateTime(text);
      if (!title && !rate && !playedAt) return [];
      return [{ title, rate, playedAt, href: sourceUrl||"" }];
    }

    // ====== 履歴（一覧）複数件抽出 ======
    function parseRecordsFromList(html, sourceUrl) {
      const dom = new DOMParser().parseFromString(html,"text/html");
      const results = [];

      // 1) 「詳細」ボタン（a,button）を手掛かりに各ブロックを拾う
      const detailBtns = Array.from(dom.querySelectorAll("a,button"))
        .filter(el => (el.textContent||"").trim().includes("詳細"));

      const containers = Array.from(new Set(detailBtns.map(b => {
        // 近い大きめのコンテナを辿る
        let p = b; for (let i=0;i<6 && p && p.parentElement;i++) p = p.parentElement;
        return p || b.parentElement;
      })));

      for (const box of containers) {
        // タイトル候補：ブロック内の input[type=text] か、見出し系
        let title = "";
        const inps = box.querySelectorAll('input[type="text"]');
        if (inps.length) title = (inps[0].value||"").trim();
        if (!title) {
          const tEl = box.querySelector('.music_title,.musicName,.play_musicdata_title,.name,.song-name,.data_title,.title');
          if (tEl) title = (tEl.textContent||"").trim();
        }
        // 達成率はブロック内テキストの最大%を採用
        const txt = (box.textContent||"").replace(/\s+/g," ");
        const rate = extractMaxPercent(txt);
        const playedAt = extractDateTime(txt);

        // それっぽいものだけ採用（タイトル or % がある）
        if (title || rate) {
          results.push({ title, rate, playedAt, href: sourceUrl||"" });
        }
      }

      // 2) もし 0 件なら、保険として大枠からざっくり拾う
      if (!results.length) {
        const blocks = Array.from(dom.querySelectorAll("div,section,article"))
          .filter(el => (el.textContent||"").includes("ACHIEVEMENT"));
        for (const el of blocks) {
          const txt = (el.textContent||"").replace(/\s+/g," ");
          const rate = extractMaxPercent(txt);
          const playedAt = extractDateTime(txt);
          let title = "";
          const tIn = el.querySelector('input[type="text"]');
          if (tIn) title = (tIn.value||"").trim();
          if (!title) {
            const tEl = el.querySelector('.music_title,.musicName,.play_musicdata_title,.name,.song-name,.data_title,.title');
            if (tEl) title = (tEl.textContent||"").trim();
          }
          if (title || rate) results.push({ title, rate, playedAt, href: sourceUrl||"" });
        }
      }
      // 重複・空行整理
      return results
        .map(r => ({...r, title: (r.title||"").trim()}))
        .filter((r,i,self)=> r.title || r.rate)
        .filter((r,i,self)=> i===self.findIndex(x=>x.title===r.title && x.rate===r.rate && x.playedAt===r.playedAt));
    }

    // ====== 自動判定 ======
    function parseAuto(html, sourceUrl) {
      const u = sourceUrl||"";
      if (u.includes("/playlogDetail/")) return parseRecordsFromDetail(html, sourceUrl);
      if (u.includes("/maimai-mobile/record/")) return parseRecordsFromList(html, sourceUrl);
      // 不明な場合は「詳細扱い」にフォールバック
      return parseRecordsFromDetail(html, sourceUrl);
    }

    // ====== 画面：内容チェック ======
    $("#btnCheck").addEventListener("click", () => {
      const html = $("#html").value;
      const sourceUrl = $("#sourceUrl").value;
      const out = $("#checkOut");
      out.textContent = "";
      if (!html.trim()) { out.innerHTML = '<span class="ng">HTML が空です。</span>'; return; }
      const recs = parseAuto(html, sourceUrl);
      if (!recs.length) {
        out.innerHTML = '<span class="ng">0 件でした。</span> 履歴一覧から取りこぼす場合は「詳細ページ」でもお試しください。';
        return;
      }
      out.textContent = `解析できた件数: ${recs.length}\n\n` + JSON.stringify(recs,null,2);
    });

    // ====== API送信 ======
    async function sendToApi(records) {
      const {url, token} = getApiConfig();
      const payload = { userId: getUserId(), records };
      const res = await fetch(url, {
        method: "POST",
        mode: "cors",
        headers: {
          "Content-Type": "text/plain",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      return { status: res.status, text };
    }

    $("#btnSend").addEventListener("click", async () => {
      const html = $("#html").value;
      const sourceUrl = $("#sourceUrl").value;
      const out = $("#sendOut"); out.textContent = "";
      const recs = parseAuto(html, sourceUrl);
      if (!recs.length) { out.innerHTML = '<span class="ng">送信中止：</span> 解析結果が 0 件です。'; return; }
      out.textContent = `送信中… (${recs.length} 件)`;
      try {
        const r = await sendToApi(recs);
        out.textContent = `API status: ${r.status}\n---\n${r.text}`;
      } catch (e) {
        out.textContent = "送信失敗: " + (e && e.message ? e.message : String(e));
      }
    });

    // ====== Sync Code 保存 ======
    $("#saveSync").addEventListener("click", () => {
      const sc = $("#syncCode").value.trim();
      if (sc) localStorage.setItem(LS_KEYS.syncCode, sc);
      else localStorage.removeItem(LS_KEYS.syncCode);
      $("#userId").value = getUserId();
      alert("保存しました。");
    });

    // ====== ヒント ======
    $("#fillWarn").addEventListener("click", () => {
      const src = $("#sourceUrl").value||"";
      if (src.includes("/playlogDetail/")) {
        alert("詳細ページ → 1件を高精度で取得します。");
      } else if (src.includes("/maimai-mobile/record/")) {
        alert("履歴一覧 → 複数件を一気に取得します（タイトルや%が拾えない曲は取りこぼすことがあります）。");
      } else {
        alert("履歴一覧 または 詳細ページでブックマークレットを実行すると楽です。");
      }
    });

    // ====== 初期化 ======
    initDefaults();
    $("#userId").value   = getUserId();
    $("#syncCode").value = localStorage.getItem(LS_KEYS.syncCode)||"";
    const api = getApiConfig();
    $("#currUrl").textContent = api.url;
    $("#currTok").textContent = api.token.replace(/^(.{6}).+(.{4})$/,"$1…$2");
    tryImportFromWindowName();
  </script>
</body>
</html>
