<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>maimai Result Client (β)</title>
<style>
  :root{color-scheme:dark light}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;margin:0;background:#0d1117;color:#e6edf3}
  .wrap{max-width:960px;margin:0 auto;padding:20px}
  h1{font-size:22px;margin:8px 0 18px}
  .card{background:#0b1320;border:1px solid #263041;border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;background:#0a1524;color:#e6edf3;border:1px solid #223044;border-radius:10px;padding:10px}
  textarea{min-height:220px}
  .btn{border:0;border-radius:10px;padding:10px 14px;background:#24d1b5;color:#0b1320;font-weight:700;cursor:pointer}
  .btn.sec{background:#223044;color:#e6edf3}
  .hint{font-size:12px;opacity:.75}
  .toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#111;border:1px solid #223044;border-radius:10px;padding:10px 14px;z-index:99999}
  .muted{opacity:.8}
  code{background:#0a1524;border:1px solid #223044;border-radius:6px;padding:1px 6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>maimai Result Client (β)</h1>

  <div class="card">
    <div class="row">
      <div style="flex:1 1 280px">
        <div class="muted" style="margin:0 0 6px">API URL（自動）</div>
        <input id="apiUrl" placeholder="https://..." />
      </div>
      <div style="flex:1 1 220px">
        <div class="muted" style="margin:0 0 6px">Bearer Token（自動）</div>
        <input id="apiTok" placeholder="例: 12345..." />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="saveCfg" class="btn">設定を保存</button>
      <button id="clearCfg" class="btn sec">保存した設定を削除</button>
      <a href="javascript:(()=>{const s=document.createElement('script');s.src='https://kakigoori0803-prog.github.io/maimai-result-client/loader.js?'+Date.now();document.head.appendChild(s);})();" class="btn sec" style="text-decoration:none">ブックマークレットをコピー</a>
    </div>
    <div class="hint" style="margin-top:6px">※ この2つは端末ローカルに保存されます（localStorage）。</div>
  </div>

  <div class="card">
    <div class="muted" style="margin:0 0 6px">元ページURL（ブックマークレット経由で自動入力）</div>
    <input id="srcUrl" placeholder="https://maimaidx.jp/..." />
    <div class="hint" style="margin:8px 0 10px">
      履歴一覧 <code>/maimai-mobile/record/</code> でも、各曲の詳細 <code>/playlogDetail/</code> でもOK。<br>
      ブックマークレットを使うと <b>URL と HTML は自動入力</b> されます。
    </div>
    <div class="muted" style="margin:0 0 6px">ここに maimai のプレイ履歴ページの HTML 全体を貼り付け</div>
    <textarea id="htmlBox" placeholder=""></textarea>
    <div class="row" style="margin-top:10px">
      <button id="btnCheck" class="btn sec">内容チェック（簡易）</button>
      <button id="btnSend" class="btn">API へ送信</button>
    </div>
    <div id="log" class="hint" style="margin-top:8px;white-space:pre-wrap"></div>
  </div>

  <div class="card">
    <div class="muted">現在のAPI設定（自動）</div>
    <div id="cfgNow" style="margin-top:6px"></div>
  </div>
</div>

<script>
  const LS = {
    apiUrl:  'mrc_api_url',
    apiTok:  'mrc_api_token',
    summary: 'mrc:lastIngestSummary',
  };
  const DEFAULT_API_URL = 'https://maimai-result.onrender.com/ingest';
  const DEFAULT_BEARER  = '677212069901c46a68a76e31ad8ba32a';

  const $ = (id)=>document.getElementById(id);
  const toast = (t)=>{
    const d=document.createElement('div'); d.className='toast'; d.textContent=t;
    document.body.appendChild(d); setTimeout(()=>d.remove(), 3500);
  };

  function loadCfg() {
    $('apiUrl').value = localStorage.getItem(LS.apiUrl) || DEFAULT_API_URL;
    $('apiTok').value = localStorage.getItem(LS.apiTok) || DEFAULT_BEARER;
    $('cfgNow').textContent = `API URL: ${$('apiUrl').value}\nBearer: ${$('apiTok').value ? $('apiTok').value.slice(0,6)+'…'+$('apiTok').value.slice(-4) : '(未設定)'}`;
  }
  function saveCfg() {
    localStorage.setItem(LS.apiUrl, $('apiUrl').value.trim());
    localStorage.setItem(LS.apiTok, $('apiTok').value.trim());
    loadCfg(); toast('保存しました');
  }
  function clearCfg() {
    localStorage.removeItem(LS.apiUrl);
    localStorage.removeItem(LS.apiTok);
    loadCfg(); toast('保存した設定を削除しました');
  }

  // 直前の送信サマリ（ブックマークレット完了 → 自動遷移で ?done=1 ）
  (function showDoneToast() {
    const q = new URLSearchParams(location.search);
    if (!q.has('done')) return;
    try {
      const s = JSON.parse(localStorage.getItem(LS.summary) || '{}');
      if (typeof s.ok === 'number')
        toast(`送信完了: ${s.ok}/${s.total}、失敗: ${s.fail}`);
    } catch (_) {}
  })();

  // もし window.name で渡されたデータがあれば拾っておく（保険）
  (function readWindowName() {
    try {
      if (window.name && /^MAI:/.test(window.name)) {
        const raw = decodeURIComponent(escape(atob(window.name.slice(4))));
        const payload = JSON.parse(raw);
        $('srcUrl').value = payload.sourceUrl || '';
        $('htmlBox').value = payload.html || '';
        window.name = ''; // クリア
        toast('ブックマークレットからデータを受け取りました');
      }
    } catch (_) {}
  })();

  // UI バインド
  $('saveCfg').onclick  = saveCfg;
  $('clearCfg').onclick = clearCfg;

  $('btnCheck').onclick = ()=>{
    const h = $('htmlBox').value;
    if (!h) { toast('HTMLが空です'); return; }
    // 簡易: playlogDetail の出現数を数える
    const m = (h.match(/\/maimai-mobile\/record\/playlogDetail\//g)||[]).length;
    $('log').textContent = `簡易チェック: 詳細リンクの検出 ${m} 件`;
  };

  $('btnSend').onclick = async ()=>{
    const api = (localStorage.getItem(LS.apiUrl) || DEFAULT_API_URL).trim();
    const tok = (localStorage.getItem(LS.apiTok) || DEFAULT_BEARER).trim();
    const html = $('htmlBox').value;
    const src  = $('srcUrl').value;
    if (!html) { toast('HTMLが空です'); return; }
    $('log').textContent = '送信中…';
    try {
      const res = await fetch(api, {
        method:'POST',
        headers: {'content-type':'application/json', ...(tok?{'authorization':'Bearer '+tok}:{})},
        body: JSON.stringify({ html, sourceUrl: src || location.href }),
        mode:'cors',
      });
      const js = await res.json().catch(()=> ({}));
      $('log').textContent = `API status: ${res.status} (${res.ok?'OK':'NG'})\n---\n${JSON.stringify(js,null,2)}`;
      toast(res.ok?'送信しました':'送信エラー');
    } catch (e) {
      $('log').textContent = '送信失敗: '+e;
      toast('送信失敗');
    }
  };

  loadCfg();
</script>
</body>
</html>
