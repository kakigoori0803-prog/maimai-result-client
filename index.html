<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>maimai Result Client (β)</title>
<style>
  :root { color-scheme: dark; }
  body { margin: 0 auto; padding: 24px; max-width: 920px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif; }
  h1 { font-size: 28px; margin: 0 0 16px; }
  section { border: 1px solid #333; border-radius: 10px; padding: 16px; margin: 18px 0; background: #111; }
  .row { display: grid; grid-template-columns: 140px 1fr; gap: 10px 14px; align-items: center; margin: 10px 0; }
  label { opacity: .85; }
  input[type="text"], input[type="url"], textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #333; background:#0a0a0a; color:#fff; font-size: 16px; }
  textarea { min-height: 220px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono","Noto Sans Mono", monospace; }
  .btns { display: flex; gap: 10px; flex-wrap: wrap; }
  button { appearance: none; border: 1px solid #2f6; background: #143; color:#eaffea; padding: 10px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; }
  button.subtle { border-color:#444; background:#1a1a1a; color:#ddd; }
  button.warn { border-color:#f66; background:#421616; color:#fee; }
  .muted { opacity: .75; font-size: 13px; }
  table { width: 100%; border-collapse: collapse; margin-top: 12px; }
  th, td { border-bottom: 1px solid #2a2a2a; padding: 10px; text-align: left; vertical-align: top; }
  code { background:#1b1b1b; padding: 2px 6px; border-radius: 6px; }
  .ok { color:#8cff9b; }
  .err { color:#ff8f8f; white-space: pre-wrap; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono","Noto Sans Mono", monospace; }
</style>
</head>
<body>
  <h1>maimai Result Client (β)</h1>
  <p class="muted">① プレイ履歴ページの HTML を丸ごと貼り付け → ② <b>解析</b> → ③ 必要なら <b>API 送信</b></p>

  <!-- API 設定 -->
  <section>
    <h2>API 設定（任意）</h2>
    <div class="row">
      <label for="apiUrlInput">API URL</label>
      <input id="apiUrlInput" type="url" placeholder="https://example.onrender.com/ingest" />
    </div>
    <div class="row">
      <label for="apiTokenInput">Bearer Token</label>
      <input id="apiTokenInput" type="text" placeholder="例: 12345..." />
    </div>
    <div class="btns">
      <button id="saveCfgBtn">設定を保存</button>
      <button id="clearCfgBtn" class="subtle">保存した設定を削除</button>
    </div>
    <p class="muted">※この2つは端末ローカル（localStorage）に保存されます。</p>
  </section>

  <!-- 入力 -->
  <section>
    <h2>HTML 貼り付け</h2>
    <div class="row">
      <label for="sourceUrl">元ページのURL</label>
      <input id="sourceUrl" type="url" placeholder="自動入力されます" />
    </div>
    <textarea id="htmlInput" placeholder="ここに maimai のプレイ履歴ページの HTML 全体を貼り付け"></textarea>
    <div class="btns" style="margin-top:10px">
      <button id="analyzeBtn">解析する</button>
      <button id="clearInputBtn" class="subtle">消去</button>
    </div>
    <div id="parseStatus" class="muted"></div>
  </section>

  <!-- 結果 -->
  <section>
    <h2>解析結果</h2>
    <table id="resultsTable">
      <thead>
        <tr><th>#</th><th>Title</th><th>Rate</th><th>PlayedAt</th><th>URL</th></tr>
      </thead>
      <tbody id="resultsBody"><tr><td colspan="5" class="muted">まだ結果はありません。</td></tr></tbody>
    </table>
    <div class="btns">
      <button id="sendBtn">APIへ送信</button>
    </div>
    <div id="sendStatus" class="muted"></div>
  </section>

  <!-- ブックマークレット -->
  <section>
    <h2>ブックマークレット（任意）</h2>
    <p class="muted">このページの URL を自動指定し、<b>HTML＋設定</b>を渡します（初回も自動保存）。</p>
    <div class="row">
      <label>あなたのページ</label>
      <input id="destUrl" type="url" />
    </div>
    <div class="btns">
      <button id="genBM">ブックマークレットを生成</button>
      <button id="copyBM" class="subtle">コードをコピー</button>
    </div>
    <textarea id="bmCode" class="mono" placeholder="ここにコードが出ます"></textarea>
  </section>

<script>
/* ========== ユーティリティ & 保存 ========== */
const $ = (sel) => document.querySelector(sel);
const els = {
  api:   $('#apiUrlInput'),
  tok:   $('#apiTokenInput'),
  url:   $('#sourceUrl'),
  html:  $('#htmlInput'),
  rbody: $('#resultsBody'),
  pstat: $('#parseStatus'),
  sstat: $('#sendStatus'),
  dest:  $('#destUrl'),
  bm:    $('#bmCode'),
};

const store = {
  get api()   { return localStorage.getItem('apiUrl')   || ''; },
  set api(v)  { localStorage.setItem('apiUrl',   v||''); },
  get token() { return localStorage.getItem('apiToken') || ''; },
  set token(v){ localStorage.setItem('apiToken', v||''); },
};

function hydrateUIFromStore() {
  if (els.api) els.api.value = store.api;
  if (els.tok) els.tok.value = store.token;
}

/* ========== window.name / #fragment 受け取り ========== */
(function receiveFromBookmarkOrHash() {
  // 1) window.name (MAI:BASE64(JSON))
  try {
    if (window.name && window.name.startsWith('MAI:')) {
      const json = decodeURIComponent(escape(atob(window.name.slice(4))));
      const payload = JSON.parse(json);
      if (payload) {
        if (payload.config) {
          if (payload.config.api)   store.api   = payload.config.api;
          if (payload.config.token) store.token = payload.config.token;
        }
        if (payload.sourceUrl && els.url)  els.url.value  = payload.sourceUrl;
        if (payload.html && els.html)      els.html.value = payload.html;
      }
      window.name = ''; // 消しておく
    }
  } catch(e){ console.error(e); }

  // 2) URLフラグメント #api=...&token=... → 保存 & アドレスバーから除去
  try {
    if (location.hash && location.hash.includes('=')) {
      const params = new URLSearchParams(location.hash.slice(1));
      const api   = params.get('api');
      const token = params.get('token');
      if (api)   store.api   = api;
      if (token) store.token = token;
      history.replaceState({}, '', location.pathname);
    }
  } catch(e){ console.error(e); }

  // ストア → UI
  hydrateUIFromStore();
})();

/* ========== API 設定ボタン ========== */
$('#saveCfgBtn')?.addEventListener('click', () => {
  store.api   = els.api.value.trim();
  store.token = els.tok.value.trim();
  alert('保存しました');
});
$('#clearCfgBtn')?.addEventListener('click', () => {
  if (!confirm('保存済みの API URL / Token を削除しますか？')) return;
  store.api = ''; store.token = '';
  hydrateUIFromStore();
  alert('削除しました');
});

/* ========== 解析 ========== */
$('#clearInputBtn')?.addEventListener('click', () => {
  els.html.value = ''; els.url.value = '';
  els.pstat.textContent = '';
  els.rbody.innerHTML = '<tr><td colspan="5" class="muted">まだ結果はありません。</td></tr>';
});

$('#analyzeBtn')?.addEventListener('click', () => {
  const html = els.html.value;
  if (!html.trim()) { els.pstat.textContent = 'HTMLが空です。'; return; }
  const items = parseMaimai(html, els.url.value.trim());
  renderResults(items);
});

/* ざっくりパーサ：タイトル／達成率／日時をできるだけ拾う */
function parseMaimai(html, href) {
  const dom = new DOMParser().parseFromString(html, 'text/html');

  // タイトル候補
  const title =
    dom.querySelector('.h_ach1')?.textContent?.trim() ||
    dom.querySelector('.music_name, .muzukashi-name, .name, .musicName')?.textContent?.trim() ||
    dom.querySelector('input[type="text"][value]')?.getAttribute('value')?.trim() ||
    dom.title?.trim() || '';

  // 達成率候補（% を含む数値を拾う）
  let rate = '';
  const textAll = dom.body ? dom.body.textContent : '';
  const m = textAll && textAll.match(/(\d{1,3}\.\d{2,5})\s*%/);
  if (m) rate = m[1];

  // 日時候補
  const playedAt =
    dom.querySelector('.play_datalist .date, .date, time, .playedAt')?.textContent?.trim() || '';

  const item = { title, rate, playedAt, href: href || '' };
  return [item];
}

function renderResults(items) {
  if (!items || !items.length) {
    els.rbody.innerHTML = '<tr><td colspan="5" class="muted">解析できませんでした。</td></tr>';
    els.pstat.textContent = '解析失敗';
    return;
  }
  els.rbody.innerHTML = items.map((it, i) => `
    <tr>
      <td>${i+1}</td>
      <td>${escapeHtml(it.title||'')}</td>
      <td class="mono">${escapeHtml(it.rate||'')}</td>
      <td class="mono">${escapeHtml(it.playedAt||'')}</td>
      <td class="mono">${it.href ? `<a href="${it.href}" target="_blank" rel="noopener">link</a>` : ''}</td>
    </tr>
  `).join('');
  els.pstat.innerHTML = `<span class="ok">解析OK</span> ${items.length}件`;
}
function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

/* ========== API 送信 ========== */
$('#sendBtn')?.addEventListener('click', async () => {
  const rows = [...els.rbody.querySelectorAll('tr')];
  if (!rows.length || rows[0].querySelector('.muted')) {
    els.sstat.textContent = '送信するデータがありません。';
    return;
  }
  const api = store.api.trim();
  if (!api) { els.sstat.textContent = 'API URL が未設定です。'; return; }

  // テーブル → アイテム
  const items = [...rows].map((tr) => {
    const tds = tr.querySelectorAll('td');
    return {
      title:    tds[1]?.textContent?.trim() || '',
      rate:     tds[2]?.textContent?.trim() || '',
      playedAt: tds[3]?.textContent?.trim() || '',
      href:     (tds[4]?.querySelector('a')?.href) || ''
    };
  });

  els.sstat.textContent = '送信中…';
  try {
    const headers = { 'Content-Type': 'application/json' };
    if (store.token) headers['Authorization'] = `Bearer ${store.token}`;
    const res = await fetch(api, {
      method: 'POST',
      headers,
      body: JSON.stringify({ items })
    });
    const text = await res.text().catch(()=> '');
    if (!res.ok) throw new Error(text || (`HTTP ${res.status}`));
    els.sstat.innerHTML = `<span class="ok">送信OK</span> ${escapeHtml(text)}`;
  } catch (e) {
    els.sstat.innerHTML = `<span class="err">送信エラー：${escapeHtml(String(e.message||e))}</span>`;
  }
});

/* ========== ブックマークレット生成 ========== */
function currentDest() {
  // いま開いている index.html のURL（#は除去）
  return location.origin + location.pathname.replace(/index\.html?$/i,'');
}
function buildBookmarklet(destUrl, api, token) {
  const DEST  = destUrl.endsWith('/') ? destUrl : (destUrl + '/');
  const A     = api   ? `'${api.replace(/'/g,"\\'")}'`   : "''";
  const T     = token ? `'${token.replace(/'/g,"\\'")}'` : "''";
  return `javascript:(()=>{try{
const DEST='${DEST}';const API=${A};const TOKEN=${T};
const payload={html:document.documentElement.outerHTML,sourceUrl:location.href,config:{api:API,token:TOKEN}};
window.name='MAI:'+btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
const frag=new URLSearchParams(); if(API)frag.set('api',API); if(TOKEN)frag.set('token',TOKEN);
location.href=DEST+(frag.toString()?('#'+frag.toString()):'');
}catch(e){alert('Bookmarklet error: '+(e&&e.message?e.message:e));}})();`;
}
function setDefaultDest() { els.dest.value = currentDest(); }
setDefaultDest();

$('#genBM')?.addEventListener('click', () => {
  const code = buildBookmarklet(els.dest.value.trim() || currentDest(), store.api, store.token);
  els.bm.value = code;
});
$('#copyBM')?.addEventListener('click', async () => {
  if (!els.bm.value) { const code = buildBookmarklet(els.dest.value.trim() || currentDest(), store.api, store.token); els.bm.value = code; }
  try { await navigator.clipboard.writeText(els.bm.value); alert('コピーしました'); }
  catch { els.bm.select(); document.execCommand('copy'); alert('コピーしました（互換）'); }
});

/* ========== 初期UI反映（ロード時） ========== */
document.addEventListener('DOMContentLoaded', ()=> {
  hydrateUIFromStore();
});
</script>
</body>
</html>
