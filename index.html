<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>maimai Result Client (β)</title>
  <style>
    :root{color-scheme:dark light}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px;background:#0b0b0c;color:#e7e7ea}
    h1{font-size:22px;margin:0 0 16px}
    section{background:#151517;border:1px solid #2a2a2e;border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;font-size:12px;opacity:.8;margin:6px 0}
    input,textarea,button{width:100%;box-sizing:border-box;border-radius:10px;border:1px solid #2a2a2e;background:#0f0f12;color:#e7e7ea;padding:12px;font-size:16px}
    textarea{min-height:220px;line-height:1.4}
    .row{display:grid;gap:10px}
    .row.cols2{grid-template-columns:1fr 1fr}
    .btns{display:flex;gap:8px;margin-top:10px}
    .btns>button{flex:1}
    .primary{background:#2f7bff;border-color:#2f7bff}
    small{opacity:.7}
  </style>
</head>
<body>
  <h1>maimai Result Client (β)</h1>

  <section>
    <h2 style="margin:0 0 8px;font-size:18px">API 設定（任意）</h2>
    <label>API URL</label>
    <input id="apiUrl" placeholder="https://example.com/ingest" value="https://maimai-result.onrender.com/ingest" />
    <label>Bearer Token（あれば）</label>
    <input id="bearerToken" placeholder="例: 12345..." />
    <div class="btns">
      <button id="saveSettings" class="primary">設定を保存</button>
      <button id="clearSettings">保存した設定を削除</button>
    </div>
    <small>※この2つは端末ローカルに保存されます（localStorage）。</small>
  </section>

  <section>
    <h2 style="margin:0 0 8px;font-size:18px">HTML 貼り付け</h2>
    <label>プレイ履歴ページの HTML 全体を貼り付け</label>
    <textarea id="htmlInput" placeholder="ここに maimai のプレイ履歴ページの HTML を貼り付け"></textarea>
    <div class="btns">
      <button id="analyze" class="primary">解析する</button>
      <button id="clearInput">クリア</button>
    </div>
    <div id="status" style="margin-top:10px;font-size:14px;opacity:.85;"></div>
  </section>

  <section>
    <h2 style="margin:0 0 8px;font-size:18px">解析結果（デモ）</h2>
    <div id="results" style="white-space:pre-wrap;font-family:ui-monospace,Menlo,monospace;font-size:13px;opacity:.9"></div>
  </section>

  <script>
    // ---- 設定の保存/復元 ----
    const $ = (q)=>document.querySelector(q);
    const apiUrlEl = $('#apiUrl');
    const tokenEl  = $('#bearerToken');
    const loadSettings = ()=>{
      apiUrlEl.value = localStorage.getItem('apiUrl') || apiUrlEl.value;
      tokenEl.value  = localStorage.getItem('bearerToken') || '';
    };
    const saveSettings = ()=>{
      localStorage.setItem('apiUrl', apiUrlEl.value.trim());
      localStorage.setItem('bearerToken', tokenEl.value.trim());
      $('#status').textContent = '設定を保存しました。';
    };
    const clearSettings = ()=>{
      localStorage.removeItem('apiUrl');
      localStorage.removeItem('bearerToken');
      $('#status').textContent = '保存した設定を削除しました。';
    };
    $('#saveSettings').addEventListener('click', saveSettings);
    $('#clearSettings').addEventListener('click', clearSettings);
    $('#clearInput').addEventListener('click', ()=>{ $('#htmlInput').value=''; $('#results').textContent=''; $('#status').textContent='';});
    loadSettings();

    // ---- 解析（ここは最低限のダミー。あなたの解析ロジックに置き換えてOK）----
    $('#analyze').addEventListener('click', ()=>{
      const html = $('#htmlInput').value || '';
      if(!html.trim()){ $('#status').textContent='HTML が空です。'; return; }
      // 例：タイトルっぽい文字列を雑に拾って件数を出すだけ（デモ）
      const m = html.match(/ACHIEVEMENT|TRACK|MASTER|EXPERT/gi) || [];
      $('#results').textContent = `HTML 文字数: ${html.length}\nキーワード検出: ${m.length} 件`;
      $('#status').textContent = '解析（デモ）完了。';
    });
  </script>

  <!-- 受け取りブロック（Bookmarklet → window.name 経由） -->
  <script>
  (function(){
    const MARKER='MAI:';
    function readFromWindowName(){
      try{
        if(!window.name || !window.name.startsWith(MARKER)) return null;
        const b64 = window.name.slice(MARKER.length);
        window.name=''; // 二重実行防止
        const json = decodeURIComponent(escape(atob(b64)));
        return JSON.parse(json); // { html, sourceUrl }
      }catch(e){ return null; }
    }
    function applyPayload(){
      const p = readFromWindowName();
      if(!p) return;
      const ta = document.getElementById('htmlInput');
      const analyzeBtn = document.getElementById('analyze');
      if(ta) ta.value = p.html || '';
      if(analyzeBtn) analyzeBtn.click();
    }
    window.addEventListener('load', applyPayload, {once:true});
    window.addEventListener('pageshow', applyPayload, {once:true});
  })();
  </script>
</body>
</html>
