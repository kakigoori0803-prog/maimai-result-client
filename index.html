<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>maimai Result Client – 配布用（自動設定 & ユーザー分離）</title>
<style>
  :root{color-scheme:dark}
  body{margin:0 auto;max-width:960px;padding:24px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Helvetica Neue",Arial}
  h1{font-size:26px;margin:0 0 10px}
  section{background:#111;border:1px solid #2a2a33;border-radius:12px;padding:16px;margin:16px 0}
  .row{display:grid;grid-template-columns:160px 1fr;gap:10px 14px;align-items:center}
  label{opacity:.9}
  input[type="text"],input[type="url"],textarea{width:100%;box-sizing:border-box;background:#0c0c10;color:#e9e9ef;border:1px solid #2a2a33;border-radius:10px;padding:10px 12px;font:inherit}
  textarea{min-height:220px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{appearance:none;border:1px solid #1b62d4;background:#1f6feb;color:#fff;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer}
  button.subtle{background:#2a2a33;border-color:#3a3a45}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #2a2a33;padding:8px;text-align:left;vertical-align:top}
  .muted{opacity:.8;font-size:13px}
  .ok{color:#6ee7a8}.err{color:#ff8f8f;white-space:pre-wrap}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>
</head>
<body>
  <h1>maimai Result Client</h1>
  <p class="muted">① まいまい履歴 HTML を渡す（ブックマークレット推奨）→ ② <b>解析</b> → ③ <b>API送信</b>（設定＆ユーザーIDは自動）</p>

  <!-- ユーザーID（自動発行＆Sync Code 任意） -->
  <section>
    <h2>ユーザーID</h2>
    <div class="row">
      <label>あなたのID（自動）</label>
      <input id="userIdView" type="text" readonly />
    </div>
    <div class="row">
      <label>Sync Code（任意）</label>
      <input id="syncCode" type="text" placeholder="複数端末で同じIDにしたいときだけ入力" />
    </div>
    <div class="btns">
      <button id="saveSync" class="subtle">Sync Code を保存</button>
      <span class="muted">※未入力なら自動ID（UUID）を使います。</span>
    </div>
  </section>

  <!-- HTML 貼り付け -->
  <section>
    <h2>HTML 貼り付け</h2>
    <div class="row">
      <label>元ページURL</label>
      <input id="sourceUrl" type="url" placeholder="自動入力されます" />
    </div>
    <textarea id="htmlInput" placeholder="ここに maimai のプレイ履歴ページ HTML 全体を貼り付け"></textarea>
    <div class="btns">
      <button id="analyzeBtn">解析する</button>
      <button id="clearInputBtn" class="subtle">消去</button>
    </div>
    <div id="parseStatus" class="muted"></div>
  </section>

  <!-- 解析結果 -->
  <section>
    <h2>解析結果</h2>
    <table>
      <thead><tr><th>#</th><th>Title</th><th>Rate</th><th>PlayedAt</th><th>URL</th></tr></thead>
      <tbody id="resultsBody"><tr><td colspan="5" class="muted">まだ結果はありません。</td></tr></tbody>
    </table>
    <div class="btns">
      <button id="sendBtn">APIへ送信</button>
      <span id="sendStatus" class="muted"></span>
    </div>
  </section>

  <!-- ブックマークレット（配布用・自動設定内蔵） -->
  <section>
    <h2>ブックマークレット</h2>
    <p class="muted">このページへ HTML と <b>API/TOKEN/ユーザーID</b> を自動で渡します（利用者は押すだけ）。</p>
    <div class="row">
      <label>このページのURL</label>
      <input id="destUrl" type="url" />
    </div>
    <div class="btns">
      <button id="genBM">生成</button>
      <button id="copyBM" class="subtle">コピー</button>
    </div>
    <textarea id="bmCode" class="mono" placeholder="ここにコードが出ます"></textarea>
    <p class="muted">※ iOS Safari ではブックマークの <b>URL欄</b>に丸ごと1行で貼り付け、タップ実行（長押しはNG）。</p>
  </section>

<script>
/*** ▼▼▼ 固定の送信先とトークン（埋め込み済み） ▼▼▼ ***/
const DEFAULTS = {
  API:   'https://maimai-result.onrender.com/ingest',
  TOKEN: '677212069901c46a68a76e31ad8ba32a'
};
/*** ▲▲▲ ここまで ▲▲▲ ***/

const $ = s => document.querySelector(s);
const els = {
  uidView: $('#userIdView'),
  sync:    $('#syncCode'),
  saveSync:$('#saveSync'),
  url:     $('#sourceUrl'),
  html:    $('#htmlInput'),
  rbody:   $('#resultsBody'),
  pstat:   $('#parseStatus'),
  sendBtn: $('#sendBtn'),
  sstat:   $('#sendStatus'),
  dest:    $('#destUrl'),
  bm:      $('#bmCode'),
  genBM:   $('#genBM'),
  copyBM:  $('#copyBM')
};

const store = {
  get api(){ return localStorage.getItem('apiUrl') || DEFAULTS.API; },
  set api(v){ localStorage.setItem('apiUrl', v||''); },
  get token(){ return localStorage.getItem('apiToken') || DEFAULTS.TOKEN; },
  set token(v){ localStorage.setItem('apiToken', v||''); },
  get uid(){ return localStorage.getItem('userId') || ''; },
  set uid(v){ localStorage.setItem('userId', v||''); }
};

// --- ユーザーID（UUID or Sync Code） ---
function genUUID() {
  try { return crypto.randomUUID(); }
  catch { return 'u-' + Math.random().toString(36).slice(2) + Date.now().toString(36); }
}
function getUserId(){
  let id = store.uid;
  if (!id) { id = genUUID(); store.uid = id; }
  return id;
}
function applyUserIdToUI(){
  els.uidView.value = getUserId();
}
els.saveSync.addEventListener('click', ()=>{
  const v = (els.sync.value||'').trim();
  if (!v){ store.uid = genUUID(); } else { store.uid = v; }
  applyUserIdToUI();
  alert('保存しました');
});

// --- 受け取り（window.name / #hash） ---
(function receive(){
  // window.name: "MAI:" + b64(JSON)
  try{
    if (window.name && window.name.startsWith('MAI:')) {
      const json = decodeURIComponent(escape(atob(window.name.slice(4))));
      const payload = JSON.parse(json||'{}'); // { html, sourceUrl, config:{api,token,userId} }
      if (payload.config?.userId) store.uid = payload.config.userId;
      if (payload.config?.api)    store.api = payload.config.api;
      if (payload.config?.token)  store.token = payload.config.token;
      if (payload.sourceUrl && els.url)  els.url.value  = payload.sourceUrl;
      if (payload.html && els.html)      els.html.value = payload.html;
      window.name = ''; // クリア
    }
  }catch(e){ console.error(e); }

  // #api & #token & #uid も受け取れるように（サーバには送られない）
  try{
    if (location.hash && location.hash.includes('=')) {
      const q = new URLSearchParams(location.hash.slice(1));
      if (q.get('uid'))  store.uid   = q.get('uid');
      if (q.get('api'))  store.api   = q.get('api');
      if (q.get('token'))store.token = q.get('token');
      history.replaceState({},'',location.pathname);
    }
  }catch(e){ console.error(e); }

  applyUserIdToUI();
})();

// --- 解析（ざっくり。必要に応じて強化OK） ---
$('#clearInputBtn').addEventListener('click', ()=>{
  els.html.value=''; els.url.value=''; els.pstat.textContent='';
  els.rbody.innerHTML = '<tr><td colspan="5" class="muted">まだ結果はありません。</td></tr>';
});
$('#analyzeBtn').addEventListener('click', ()=>{
  const html = els.html.value;
  if (!html.trim()){ els.pstat.textContent = 'HTMLが空です。'; return; }
  const items = parseMaimai(html, els.url.value.trim());
  renderResults(items);
});

function parseMaimai(html, href){
  const dom = new DOMParser().parseFromString(html,'text/html');
  const items = [];
  // ゆるめに候補を拾う（必要に応じて強化）
  const blocks = [...dom.querySelectorAll('.playlog,.record,section,article,li,div')].slice(0,50);
  for (const el of blocks) {
    const txt = (el.textContent||'').trim();
    if (!/MASTER|EXPERT|ADVANCED|BASIC|ACHIEVEMENT|%/.test(txt)) continue;

    let title = (el.querySelector('.music_name,.music-title,.name,.musicName,h3,h4,strong')||{}).textContent||'';
    title = title.trim().replace(/\s+/g,' ');
    if (!title) continue;

    let rate = '';
    const m = txt.match(/(\d{1,3}\.\d{2,4})\s*%/);
    if (m) rate = m[1];

    let playedAt = (el.querySelector('.date,.playedAt,time')||{}).textContent||'';
    playedAt = playedAt.trim();

    items.push({ title, rate, playedAt, href });
    if (items.length>=50) break;
  }
  if (!items.length) {
    // 最低1件
    const t = (dom.title||'').trim() || 'Unknown';
    const m = (dom.body?.textContent||'').match(/(\d{1,3}\.\d{2,4})\s*%/);
    items.push({ title:t, rate:m?m[1]:'', playedAt:'', href });
  }
  return items;
}
function esc(s){ return String(s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
function renderResults(items){
  if (!items?.length){ els.rbody.innerHTML='<tr><td colspan="5" class="muted">解析できませんでした。</td></tr>'; els.pstat.textContent='解析失敗'; return; }
  els.rbody.innerHTML = items.map((it,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${esc(it.title)}</td>
      <td class="mono">${esc(it.rate)}${it.rate?'%':''}</td>
      <td class="mono">${esc(it.playedAt)}</td>
      <td class="mono">${it.href?`<a href="${it.href}" target="_blank" rel="noopener">link</a>`:''}</td>
    </tr>`).join('');
  els.pstat.innerHTML = `<span class="ok">解析OK</span> ${items.length}件`;
}

// --- 送信（userId 付き） ---
els.sendBtn.addEventListener('click', async ()=>{
  const rows = [...els.rbody.querySelectorAll('tr')];
  if (!rows.length || rows[0].querySelector('.muted')) { els.sstat.textContent='送信するデータがありません。'; return; }
  const items = rows.map(tr=>{
    const tds = tr.querySelectorAll('td');
    return {
      title: tds[1]?.textContent?.trim() || '',
      rate:  (tds[2]?.textContent?.replace('%','').trim() || ''),
      playedAt: tds[3]?.textContent?.trim() || '',
      href:  (tds[4]?.querySelector('a')?.href || '')
    };
  });

  const body = { userId: store.uid || (store.uid=crypto.randomUUID()), sourceUrl: els.url.value.trim() || null, items };
  els.sstat.textContent = '送信中…';
  try{
    const headers = { 'Content-Type':'application/json' };
    const token = store.token;
    if (token) headers.Authorization = `Bearer ${token}`;
    const res = await fetch(store.api, { method:'POST', headers, body: JSON.stringify(body) });
    const txt = await res.text().catch(()=> '');
    if (!res.ok) throw new Error(txt || `HTTP ${res.status}`);
    els.sstat.innerHTML = `<span class="ok">送信OK</span> ${esc(txt)}`;
  }catch(e){
    els.sstat.innerHTML = `<span class="err">送信エラー：${esc(e.message||String(e))}</span>`;
  }
});

// --- ブックマークレット生成（API/TOKEN/UID 内蔵 & 同タブ遷移） ---
function currentDest(){ return location.origin + location.pathname.replace(/index\.html?$/i,''); }
function setDefaultDest(){ els.dest.value = currentDest(); }
setDefaultDest();

function getUserId(){ return store.uid || (store.uid = (crypto.randomUUID?crypto.randomUUID():'u-'+Math.random().toString(36).slice(2))); }

function buildBookmarklet(destUrl){
  const DEST = destUrl.endsWith('/') ? destUrl : destUrl + '/';
  const API  = store.api.replace(/'/g,"\\'");
  const TOK  = store.token.replace(/'/g,"\\'");
  const UID  = getUserId().replace(/'/g,"\\'");
  return `javascript:(()=>{try{
const DEST='${DEST}';const API='${API}';const TOKEN='${TOK}';const USER='${UID}';
const payload={html:document.documentElement.outerHTML,sourceUrl:location.href,config:{api:API,token:TOKEN,userId:USER}};
window.name='MAI:'+btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
location.replace(DEST);
}catch(e){alert('Bookmarklet error: '+(e&&e.message?e.message:e));}})();`;
}
els.genBM.addEventListener('click', ()=>{
  els.bm.value = buildBookmarklet(els.dest.value.trim() || currentDest());
});
els.copyBM.addEventListener('click', async ()=>{
  if (!els.bm.value) els.bm.value = buildBookmarklet(els.dest.value.trim() || currentDest());
  try{ await navigator.clipboard.writeText(els.bm.value); alert('コピーしました'); }
  catch{ els.bm.select(); document.execCommand('copy'); alert('コピーしました（互換）'); }
});

// --- 初期表示 ---
document.addEventListener('DOMContentLoaded', ()=>{
  // DEFAULTS を常に適用（配布者が差し替え済み前提）
  if (!localStorage.getItem('apiUrl'))   store.api   = DEFAULTS.API;
  if (!localStorage.getItem('apiToken')) store.token = DEFAULTS.TOKEN;
  applyUserIdToUI();
});
</script>
</body>
</html>
